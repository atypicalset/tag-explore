<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>scatter plot</title>
    <!-- <link href="layout.css" rel="stylesheet" type="text/css"> -->
    <style type="text/css">
    body {
      font-family: sans-serif;
      font-size: 16px;
      margin: 50px;
      max-width: 800px;
    } </style>
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="../js/jquery-1.7.2.js"></script>
    <script language="javascript" type="text/javascript" src="../js/underscore.js"></script>
    <script language="javascript" type="text/javascript" src="../flot/jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="../flot/jquery.flot.selection.js"></script>
    <!--<script language="javascript" type="text/javascript" src="../flot/jquery.flot.navigate.js"></script>-->
    </head>
    <body>
    <h2>Scatter plot: Tag frequency vs Informativeness</h2>

    <table width=900>
        <tr>
            <td rowspan="5">
                <div id="placeholder" style="width:600px;height:500px"></div>
            </td>
            <td><div id="overview" style="width:200px;height:150px"></div>
            </td>
        </tr>
        <tr><td><span id="datacount">0</span> tags loaded.</td></tr>
        <tr><td><p><input id="enableTooltip" type="checkbox">Enable tooltip</p></td></tr>
        <tr><td><span id="clickdata"></span></td></tr>
        <tr>
            <td>
                <p id="hoverdata">Mouse hovers at
                (<span id="x">0</span>, <span id="y">0</span>).</p>
                <p id="selectdata">selected area has <span id="tagnum">inf</span> points</p>
            </td>
        </tr>
        </tr>
    
    </table>
    
    <p>Try
    pointing and clicking on the points.</p>

    <p>A tooltip is easy to build with a bit of jQuery code and the
    data returned from the plot.</p>


<script type="text/javascript">
$(function () {
    var cgi_path="/tag-explore/cgi-bin/tag_data.py"
    var wordinfo = [];
    var wdata = [];

    var xyoptions = { xaxis: {
                        min: 5,
                        //max: 200000,
                        transform:  function(v) {return Math.log(v+1e-4); /*move away from zero*/} , 
                        inverseTransform: function (v) { return Math.exp(v); },
                        tickDecimals: 0 ,
                    } ,
                    yaxis: { 
                        min: 0.35,
                        max: 4.1,
                        tickDecimals: 2,
                        transform:  function(v) {return Math.log(v); /*move away from zero*/} , 
                        inverseTransform: function (v) { return Math.exp(v); }, 
                    }
                } ;

    var over_opt = {
        legend: { show: true, container: $("#overviewLegend") },
        series: {
            points: { show: true, size: .5 },
            shadowSize: 0
        },
        grid: { color: "#999" },
        selection: { mode: "xy" }
    } ;

    var placeholder_opt = {
           series: {
               points: { show: true }
           },
           grid: { hoverable: true, clickable: true },
           selection: { mode: "xy" },
        } ;
    
    var placeholder; //plot handles
    var overview;
    var ph_handle = $("#placeholder"); //plot area handle?

    // fetch data with jQuery + python cgi
    /*
    function onDataReceived(series) {
        // extract the first coordinate pair so you can see that
        // data is now an ordinary Javascript object
        var firstcoordinate = '(' + series.data[0][0] + ', ' + series.data[0][1] + ')';

        button.siblings('span').text('Fetched ' + series.label + ', first point: ' + firstcoordinate);

        // let's add it to our current data
        if (!alreadyFetched[series.label]) {
            alreadyFetched[series.label] = true;
            data.push(series);
        }
        
        // and plot all we got
        $.plot(placeholder, data, options);
     }
    
    $.ajax({
        url: dataurl,
        method: 'GET',
        dataType: 'json',
        success: onDataReceived
    }); */

    // get initial data and setup graph
    $.getJSON('wordnet_tag.json', function(data) {
        //var items = [];

        $.each(data, function(key, val) {
            //items.push('<li id="' + key + '">' + val['word'] + ": "+ val['x'][0] + '</li>');
            wdata.push( [val['cnt'], val['ifm']] ) ;
            wordinfo.push( val['word'] );

        });
        // draw overview
        var olen = Math.round(wdata.length / 5) ;
        overview = $.plot($("#overview"), 
            [{data: _.first(_.shuffle(wdata), olen), color: 2}] ,  
            jQuery.extend(over_opt, xyoptions) );

        // now plot the whole graph
        placeholder = $.plot($("#placeholder"), 
            [{data: wdata, label: "tags", color: 2}] , 
            jQuery.extend(placeholder_opt, xyoptions));


        $("#datacount").text(wordinfo.length);
        $("#tagnum").text(wordinfo.length);

    });
    
    // now connect the two
    $("#placeholder").bind("plotselected", function (event, ranges) {
        // clamp the zooming to prevent eternal zoom
        if (ranges.xaxis.to - ranges.xaxis.from < 1e-3)
            ranges.xaxis.to = ranges.xaxis.from + 1e-3;
        if (ranges.yaxis.to - ranges.yaxis.from < 1e-3)
            ranges.yaxis.to = ranges.yaxis.from + 1e-3;
        
        // do the zooming, get the data again
        /*
        placeholder = $.plot($("#placeholder"), [{data: wdata, label: "tags", color: 2}], 
                      $.extend(true, {}, xyoptions, placeholder_opt, {
                          xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                          yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
                      }));
        */

        var args=["xfrom="+ranges.xaxis.from.toString(), "xto="+ranges.xaxis.to.toString(), 
            "yfrom="+ranges.yaxis.from.toString(), "yto="+ranges.yaxis.to.toString()] ;

        var req_url = cgi_path+"?"+args.join("&")
        console.log(req_url)

        $.getJSON(req_url, function(data) {
            var tdata=[], tagname=[];
            $.each(data, function(key, val) {
                tdata.push( [val['count'], val['infm']] ) ;
                tagname.push( val['tag'] );
            });
            
            var tlen = tagname.length;
            console.log("selected area has " + tlen.toString() + " points.")
            $("#tagnum").text(tlen);

            // now update the whole graph
            if ( tlen >= 200 ) {
                placeholder = $.plot($("#placeholder"), 
                    [{data: tdata, label: "tags", color: 2}] , 
                    $.extend(true, {}, xyoptions, placeholder_opt, {
                          xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                          yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
                      }));
            } 
            else {
                console.log(" get to the else branch")
                /*
                placeholder.setSelection(ranges);
                // display tags directly
                var o;

                o = placeholder.pointOffset({ x: tdata[0][0], y: tdata[0][1]});
                // append it to the placeholder which Flot already uses for positioning
                ph_handle.append('<div style="position:absolute;left:' + (o.left + 4) + 'px;top:' + o.top + 'px;color:#f66;font-size:smaller">'+tagname[i]+'</div>');
                */
            }


        });
        
        // don't fire event on the overview to prevent eternal loop
        overview.setSelection(ranges, true);
    });
    $("#overview").bind("plotselected", function (event, ranges) {
        placeholder.setSelection(ranges);
    });

    // respond to clicking and hovering
    function showTooltip(x, y, contents) {
        $('<div id="tooltip">' + contents + '</div>').css( {
            position: 'absolute',
            display: 'none',
            top: y + 5,
            left: x + 5,
            border: '1px solid #fdd',
            padding: '2px',
            'background-color': '#eee',
            opacity: 0.80
        }).appendTo("body").fadeIn(200);
    } ;

    var previousPoint = null;
    $("#placeholder").bind("plothover", function (event, pos, item) {
        $("#x").text(pos.x.toFixed(2));
        $("#y").text(pos.y.toFixed(2));

        if ($("#enableTooltip:checked").length > 0) {
            if (item) {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;
                    var ii = item.dataIndex;

                    $("#tooltip").remove();
                    //var x = item.datapoint[0].toFixed(2),
                    //    y = item.datapoint[1].toFixed(2);
                    var x = wdata[ii][0],
                        y = wdata[ii][1];
                    
                    showTooltip(item.pageX, item.pageY,
                                wordinfo[ii] + " (" + x + ", " + y +")");
                }
            }
            else {
                $("#tooltip").remove();
                previousPoint = null;            
            }
        }
    });

    $("#placeholder").bind("plotclick", function (event, pos, item) {
        if (item) {
            var ii = item.dataIndex;
            $("#clickdata").text(item.series.label + ' "'+ wordinfo[ii] + '": (' + wdata[ii][0]+", "+ wdata[ii][1].toFixed(2) + ") ");
            //plot.highlight(item.series, item.datapoint);
        }
    });

});
</script>

 </body>
</html>
